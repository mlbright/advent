<div class="calendar-day-edit">
  <h1>Edit Day <%= @day.day_number %> - <%= @calendar.title %></h1>
  <p class="form-help">Add an image or video with a title and description for this day.</p>

  <%= form_with model: @day, url: calendar_calendar_day_path(@calendar, @day.day_number), method: :patch, local: true do |form| %>
    <% if @day.errors.any? %>
      <div class="alert alert-danger">
        <h3><%= @day.errors.count %> <%= @day.errors.count == 1 ? 'error' : 'errors' %> prohibited this day from being saved:</h3>
        <ul>
          <% @day.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= form.label :title, "Title (optional)" %>
      <%= form.text_field :title, class: "form-control", placeholder: "A special surprise for you..." %>
    </div>

    <div class="form-group">
      <%= form.label :content_type, "Content Type" %>
      <%= form.select :content_type, 
          [['Image', 'image'], ['Video', 'video']], 
          { include_blank: 'Select type...' }, 
          { class: "form-control", required: true, id: "content_type_select" } %>
    </div>

    <div class="form-group" id="url_group">
      <%= form.label :url, "URL" %>
      <%= form.url_field :url, class: "form-control", id: "url_field",
          placeholder: "https://youtube.com/watch?v=... or https://example.com/image.jpg" %>
      <small class="form-text">Supported: YouTube, Vimeo videos, and image URLs (JPG, PNG, GIF, WEBP)</small>
    </div>

    <div id="upload_or_separator" style="display: none;">
      <p style="text-align: center; margin: 1rem 0;">— OR —</p>
    </div>

    <div class="form-group" id="image_upload_group" style="display: none;">
      <%= form.label :image_file, "Upload Image" %>
      <%= form.file_field :image_file, class: "form-control", accept: "image/jpeg,image/jpg,image/png,image/gif,image/webp", id: "image_file_field" %>
      <small class="form-text">Accepted formats: JPEG, PNG, GIF, WEBP (max 10MB)</small>
      <% if @day.image_file.attached? %>
        <div class="current-file-info" id="image_file_info">
          <p class="current-file">Current file: <%= @day.image_file.filename %> (<%= number_to_human_size(@day.image_file.byte_size) %>)</p>
        </div>
      <% end %>
    </div>
    
    <div class="form-group" id="video_upload_group" style="display: none;">
      <%= form.label :video_file, "Upload Video" %>
      <%= form.file_field :video_file, class: "form-control", accept: "video/mp4,video/quicktime,video/x-msvideo,video/webm,video/ogg", id: "video_file_field" %>
      <small class="form-text">Accepted formats: MP4, MOV, AVI, WEBM, OGG (max 100MB)</small>
      <% if @day.video_file.attached? %>
        <div class="current-file-info" id="video_file_info">
          <p class="current-file">Current file: <%= @day.video_file.filename %> (<%= number_to_human_size(@day.video_file.byte_size) %>)</p>
        </div>
      <% end %>
    </div>

    <div class="form-group">
      <%= form.label :description, "Description" %>
      <%= form.text_area :description, rows: 6, class: "form-control", 
          placeholder: "Write a message to go with this content..." %>
    </div>

    <div class="form-actions">
      <%= form.submit "Save Day Content", class: "btn btn-primary" %>
      <%= link_to "Back to Calendar", calendar_path(@calendar), class: "btn btn-secondary" %>
    </div>
  <% end %>

  <!-- Remove Content Section -->
  <% if @day.image_file.attached? || @day.video_file.attached? %>
    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #dee2e6;">
      <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">Remove Content</h3>
      
      <% if @day.image_file.attached? %>
        <%= button_to "Delete Uploaded Image", 
            delete_attachment_calendar_calendar_day_path(@calendar, @day.day_number, attachment_type: "image"), 
            method: :delete, 
            class: "btn btn-danger btn-sm", 
            data: { turbo_confirm: "Are you sure you want to delete this file?" } %>
      <% end %>
      
      <% if @day.video_file.attached? %>
        <%= button_to "Delete Uploaded Video", 
            delete_attachment_calendar_calendar_day_path(@calendar, @day.day_number, attachment_type: "video"), 
            method: :delete, 
            class: "btn btn-danger btn-sm", 
            data: { turbo_confirm: "Are you sure you want to delete this file?" } %>
      <% end %>
    </div>
  <% end %>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const contentTypeSelect = document.getElementById('content_type_select');
      const urlField = document.getElementById('url_field');
      const imageUploadGroup = document.getElementById('image_upload_group');
      const videoUploadGroup = document.getElementById('video_upload_group');
      const uploadOrSeparator = document.getElementById('upload_or_separator');
      const imageFileField = document.getElementById('image_file_field');
      const videoFileField = document.getElementById('video_file_field');
      
      function updateFileFields() {
        const contentType = contentTypeSelect.value;
        const hasUrl = urlField.value.trim() !== '';
        const hasImageFile = imageFileField && imageFileField.files.length > 0;
        const hasVideoFile = videoFileField && videoFileField.files.length > 0;
        
        // Show/hide upload options based on content type
        if (contentType === 'image') {
          imageUploadGroup.style.display = hasUrl ? 'none' : 'block';
          videoUploadGroup.style.display = 'none';
          uploadOrSeparator.style.display = hasUrl ? 'none' : 'block';
        } else if (contentType === 'video') {
          imageUploadGroup.style.display = 'none';
          videoUploadGroup.style.display = hasUrl ? 'none' : 'block';
          uploadOrSeparator.style.display = hasUrl ? 'none' : 'block';
        } else {
          imageUploadGroup.style.display = 'none';
          videoUploadGroup.style.display = 'none';
          uploadOrSeparator.style.display = 'none';
        }
        
        // Make URL field readonly if file is selected (not disabled, so it still submits)
        if (contentType === 'image' && hasImageFile) {
          urlField.readOnly = true;
          urlField.style.backgroundColor = '#e9ecef';
        } else if (contentType === 'video' && hasVideoFile) {
          urlField.readOnly = true;
          urlField.style.backgroundColor = '#e9ecef';
        } else {
          urlField.readOnly = false;
          urlField.style.backgroundColor = '';
        }
      }
      
      contentTypeSelect.addEventListener('change', updateFileFields);
      urlField.addEventListener('input', updateFileFields);
      if (imageFileField) imageFileField.addEventListener('change', updateFileFields);
      if (videoFileField) videoFileField.addEventListener('change', updateFileFields);
      
      updateFileFields(); // Initialize on page load
    });
  </script>
</div>
