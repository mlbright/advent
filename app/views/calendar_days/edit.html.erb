<div class="calendar-day-edit">
  <h1>Edit Day <%= @day.day_number %> - <%= @calendar.title %></h1>
  <p class="form-help">Add an image or video with a title and description for this day. The content type will be automatically detected.</p>

  <%= form_with model: @day, url: calendar_calendar_day_path(@calendar, @day.day_number), method: :patch, local: true do |form| %>
    <% if @day.errors.any? %>
      <div class="alert alert-danger">
        <h3><%= @day.errors.count %> <%= @day.errors.count == 1 ? 'error' : 'errors' %> prohibited this day from being saved:</h3>
        <ul>
          <% @day.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= form.label :title, "Title (optional)" %>
      <%= form.text_field :title, class: "form-control", placeholder: "A special surprise for you..." %>
    </div>

    <div class="form-group">
      <%= form.label :url, "URL (Image or Video)" %>
      <%= form.url_field :url, class: "form-control", id: "url_field",
          placeholder: "https://youtube.com/watch?v=... or https://example.com/image.jpg" %>
      <small class="form-text">Supported: YouTube, Vimeo videos, and image URLs (JPG, PNG, GIF, WEBP)</small>
      <div id="detected_type_url" style="margin-top: 0.5rem; display: none;">
        <span class="badge badge-info">Detected: <span id="detected_type_url_text"></span></span>
      </div>
    </div>

    <div id="upload_or_separator">
      <p style="text-align: center; margin: 1rem 0;">— OR —</p>
    </div>

    <div class="form-group" id="file_upload_group">
      <%= form.label :media_file, "Upload Image or Video" %>
      <%= form.file_field :media_file, class: "form-control", 
          accept: "image/jpeg,image/jpg,image/png,image/gif,image/webp,video/mp4,video/quicktime,video/x-msvideo,video/webm,video/ogg", 
          id: "media_file_field" %>
      <small class="form-text">Images: JPEG, PNG, GIF, WEBP (max 10MB) | Videos: MP4, MOV, AVI, WEBM, OGG (max 100MB)</small>
      <div id="detected_type_file" style="margin-top: 0.5rem; display: none;">
        <span class="badge badge-info">Detected: <span id="detected_type_file_text"></span></span>
      </div>
      <% if @day.image_file.attached? %>
        <div class="current-file-info">
          <p class="current-file">Current file: <%= @day.image_file.filename %> (<%= number_to_human_size(@day.image_file.byte_size) %>)</p>
        </div>
      <% end %>
      <% if @day.video_file.attached? %>
        <div class="current-file-info">
          <p class="current-file">Current file: <%= @day.video_file.filename %> (<%= number_to_human_size(@day.video_file.byte_size) %>)</p>
        </div>
      <% end %>
    </div>

    <div class="form-group">
      <%= form.label :description, "Description" %>
      <%= form.text_area :description, rows: 6, class: "form-control", 
          placeholder: "Write a message to go with this content..." %>
    </div>

    <div class="form-actions">
      <%= form.submit "Save Day Content", class: "btn btn-primary" %>
      <%= link_to "Back to Calendar", calendar_path(@calendar), class: "btn btn-secondary" %>
    </div>
  <% end %>

  <!-- Remove Content Section -->
  <% if @day.image_file.attached? || @day.video_file.attached? %>
    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #dee2e6;">
      <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">Remove Content</h3>
      
      <% if @day.image_file.attached? %>
        <%= button_to "Delete Uploaded Image", 
            delete_attachment_calendar_calendar_day_path(@calendar, @day.day_number, attachment_type: "image"), 
            method: :delete, 
            class: "btn btn-danger btn-sm", 
            data: { turbo_confirm: "Are you sure you want to delete this file?" } %>
      <% end %>
      
      <% if @day.video_file.attached? %>
        <%= button_to "Delete Uploaded Video", 
            delete_attachment_calendar_calendar_day_path(@calendar, @day.day_number, attachment_type: "video"), 
            method: :delete, 
            class: "btn btn-danger btn-sm", 
            data: { turbo_confirm: "Are you sure you want to delete this file?" } %>
      <% end %>
    </div>
  <% end %>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const urlField = document.getElementById('url_field');
      const fileUploadGroup = document.getElementById('file_upload_group');
      const uploadOrSeparator = document.getElementById('upload_or_separator');
      const mediaFileField = document.getElementById('media_file_field');
      const detectedTypeUrl = document.getElementById('detected_type_url');
      const detectedTypeUrlText = document.getElementById('detected_type_url_text');
      const detectedTypeFile = document.getElementById('detected_type_file');
      const detectedTypeFileText = document.getElementById('detected_type_file_text');
      
      function detectContentTypeFromUrl(url) {
        if (!url) return null;
        
        try {
          const urlObj = new URL(url);
          
          // Check for video hosting platforms
          if (/(youtube\\.com|youtu\\.be|vimeo\\.com|dailymotion\\.com|twitch\\.tv)/i.test(urlObj.hostname)) {
            return 'video';
          }
          
          // Check file extension
          const path = urlObj.pathname.toLowerCase();
          if (/\\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(path)) {
            return 'image';
          }
          if (/\\.(mp4|mov|avi|webm|ogg|mkv|flv|wmv)$/i.test(path)) {
            return 'video';
          }
        } catch (e) {
          return null;
        }
        
        return null;
      }
      
      function detectContentTypeFromFile(file) {
        if (!file) return null;
        
        const type = file.type;
        if (type.startsWith('image/')) return 'image';
        if (type.startsWith('video/')) return 'video';
        
        return null;
      }
      
      function updateFileFields() {
        const urlValue = urlField.value.trim();
        const hasUrl = urlValue !== '';
        const hasFile = mediaFileField && mediaFileField.files.length > 0;
        
        // Detect content type from URL
        if (hasUrl) {
          const detectedType = detectContentTypeFromUrl(urlValue);
          if (detectedType) {
            detectedTypeUrl.style.display = 'block';
            detectedTypeUrlText.textContent = detectedType.charAt(0).toUpperCase() + detectedType.slice(1);
          } else {
            detectedTypeUrl.style.display = 'none';
          }
        } else {
          detectedTypeUrl.style.display = 'none';
        }
        
        // Detect content type from file
        if (hasFile) {
          const file = mediaFileField.files[0];
          const detectedType = detectContentTypeFromFile(file);
          if (detectedType) {
            detectedTypeFile.style.display = 'block';
            detectedTypeFileText.textContent = detectedType.charAt(0).toUpperCase() + detectedType.slice(1);
          } else {
            detectedTypeFile.style.display = 'none';
          }
        } else {
          detectedTypeFile.style.display = 'none';
        }
        
        // Show/hide upload field based on what's filled
        if (hasUrl) {
          fileUploadGroup.style.display = 'none';
          uploadOrSeparator.style.display = 'none';
        } else if (hasFile) {
          fileUploadGroup.style.display = 'block';
          uploadOrSeparator.style.display = 'block';
          urlField.readOnly = true;
          urlField.style.backgroundColor = '#e9ecef';
        } else {
          fileUploadGroup.style.display = 'block';
          uploadOrSeparator.style.display = 'block';
          urlField.readOnly = false;
          urlField.style.backgroundColor = '';
        }
      }
      
      urlField.addEventListener('input', updateFileFields);
      if (mediaFileField) mediaFileField.addEventListener('change', updateFileFields);
      
      updateFileFields(); // Initialize on page load
    });
  </script>
</div>
